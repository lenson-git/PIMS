<script>
    // 全局配置映射缓存
    window._settingsCache = {
        shop: {},
        warehouse: {},
        inbound_type: {},
        outbound_type: {}
    };

    /**
     * 页面导航控制
     * @param {string} viewName - 视图ID
     */
    function navigate(viewName) {
        // 更新导航高亮
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
        
        // 切换视图
        document.querySelectorAll('.view').forEach(view => {
            view.classList.remove('active');
        });
        document.getElementById(viewName + '-view').classList.add('active');
        
        // 更新标题
        const titles = {
            'dashboard': '仪表盘',
            'sku': 'SKU管理',
            'inbound': '入库',
            'outbound': '出库',
            'stock': '库存管理',
            'expenses': '费用管理'
        };
        document.getElementById('page-title').textContent = titles[viewName];
    }

    /**
     * 打开模态框
     * @param {string} modalId - 模态框ID
     */
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        // 重新初始化浮动标签（针对模态框内的元素）
        setTimeout(initFloatingLabels, 50);
    }

    /**
     * 关闭模态框
     * @param {string} modalId - 模态框ID
     */
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // 点击遮罩关闭模态框
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    });

    /**
     * 显示 SKU 详情模态框
     * @param {string} skuId - SKU ID
     */
    function showSKUDetails(skuId) {
        // TODO: 从后端获取 SKU 详细信息
        alert('显示 SKU 详情: ' + skuId + '\n\n此功能将在后端集成时实现');
    }

    /**
     * 显示灯箱（图片放大）
     * @param {string} src - 图片 URL
     */
    function showLightbox(src) {
        const lightbox = document.getElementById('global-lightbox');
        if (lightbox) {
            const img = lightbox.querySelector('img');
            img.src = src;
            lightbox.classList.add('active');
        }
    }

    /**
     * 关闭灯箱
     */
    function closeLightbox() {
        const lightbox = document.getElementById('global-lightbox');
        if (lightbox) {
            lightbox.classList.remove('active');
        }
    }

    /**
     * 批量导入 SKU (占位)
     */
    function importSKU() {
        alert('批量导入功能即将上线');
    }

    /**
     * 初始化浮动标签 - 处理 select 元素
     */
    function initFloatingLabels() {
        document.querySelectorAll('.floating-label-group select').forEach(select => {
            // 如果已经初始化过，跳过
            if (select.dataset.floatingInit) return;
            select.dataset.floatingInit = 'true';
            
            // 检查是否有值，添加 active 类
            function updateLabel() {
                if (select.value && select.value !== '') {
                    select.parentElement.classList.add('active');
                } else {
                    select.parentElement.classList.remove('active');
                }
            }
            
            // 初始化
            updateLabel();
            
            // 监听变化
            select.addEventListener('change', updateLabel);
            select.addEventListener('focus', () => {
                select.parentElement.classList.add('active');
            });
        });
    }

    /**
     * 获取配置项的显示名称（全局函数）
     * @param {string} type - 配置类型 (shop, warehouse, etc.)
     * @param {string} code - 配置代码
     * @returns {string} - 显示名称，如果未找到则返回代码本身
     */
    window.getSettingName = function(type, code) {
        if (!code) return '';
        if (window._settingsCache[type] && window._settingsCache[type][code]) {
            return window._settingsCache[type][code];
        }
        return code; // 如果缓存中没有，返回代码本身
    };

    /**
     * 加载下拉列表选项
     * @param {string} selectName - select 元素的 name 属性
     * @param {string} type - 配置类型 (shop, warehouse 等)
     * @param {string} [selectedValue] - 默认选中的值
     */
    function loadSelectOptions(selectName, type, selectedValue) {
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.success) {
                    // 更新全局缓存
                    if (!window._settingsCache[type]) {
                        window._settingsCache[type] = {};
                    }
                    response.data.forEach(item => {
                        window._settingsCache[type][item.code || item.name] = item.name;
                    });
                    
                    const selects = document.querySelectorAll(`select[name="${selectName}"]`);
                    selects.forEach(select => {
                        // 保存特殊选项 (空值和新建)
                        let specialOptions = [];
                        Array.from(select.options).forEach(opt => {
                            if (opt.value === '' || opt.value === '__new__') {
                                specialOptions.push(opt);
                            }
                        });
                        
                        // 清空
                        select.innerHTML = '';
                        
                        // 1. 添加空选项 (如果有)
                        const emptyOpt = specialOptions.find(o => o.value === '');
                        if (emptyOpt) select.appendChild(emptyOpt);
                        
                        // 2. 添加动态选项
                        response.data.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.code || item.name;
                            option.textContent = item.name;
                            if (selectedValue && option.value === selectedValue) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                        
                        // 3. 添加新建选项 (如果有)
                        const newOpt = specialOptions.find(o => o.value === '__new__');
                        if (newOpt) select.appendChild(newOpt);
                        
                        // 更新浮动标签状态
                        if (select.value) {
                            select.parentElement.classList.add('active');
                        }
                    });
                } else {
                    console.error('Failed to load settings for ' + type + ':', response.error);
                }
            })
            .withFailureHandler(function(error) {
                console.error('Error loading settings:', error);
            })
            .getSettings(type);
    }

    // DOM 加载完成后初始化
    document.addEventListener('DOMContentLoaded', initFloatingLabels);
</script>

<!-- 全局灯箱 -->
<div id="global-lightbox" class="lightbox-overlay" onclick="closeLightbox()">
    <div class="lightbox-content">
        <img src="" alt="Large View">
        <button class="lightbox-close">&times;</button>
    </div>
</div>

<style>
    .lightbox-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 2000;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: zoom-out;
    }

    .lightbox-overlay.active {
        display: flex;
        animation: fadeIn 0.2s;
    }

    .lightbox-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }

    .lightbox-content img {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 4px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .lightbox-close {
        position: absolute;
        top: -40px;
        right: 0;
        background: none;
        border: none;
        color: white;
        font-size: 32px;
        cursor: pointer;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
</style>
